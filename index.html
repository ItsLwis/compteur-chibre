<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compteur Chibre</title>
  <meta name="description" content="Compteur Chibre — PWA hors-ligne simple, avec jauge et historique.">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <style>
    :root{
      --bg:#000; --ink:#fff; --muted:#9ca3af;
      --line:#ffffff33; --center:#ffffff; --accent:#b7ff4a;
      --chip:#0f172a; --chipbd:#1f2937; --danger:#ef4444;
      --card:#0e0e0e; --ok:#22c55e; --okbg:#c7f9cc;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:520px;margin:0 auto;padding:14px 14px 24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand img{border-radius:6px}
    .brand h1{margin:0;font-size:18px}
    .actions{display:flex;gap:8px}
    .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0e0e0e;color:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .iconbtn svg{width:18px;height:18px;fill:#fff;opacity:.9}
    .iconbtn.danger{background:#180c0c;border-color:#3a1717}

    .board{position:relative;border:1px solid var(--line);border-radius:12px;padding:18px;min-height:72vh;background:linear-gradient(180deg,#0a0a0a,#0f0f0f)}
    .centerline{position:absolute;left:50%;top:10%;bottom:10%;transform:translateX(-50%);width:6px;background:var(--center);border-radius:3px}
    .midmark{position:absolute;left:10%;right:10%;top:50%;height:1px;background:var(--line)}
    .gauge{position:absolute;left:50%;transform:translateX(-50%);width:6px;background:var(--accent);border-radius:3px}
    .gauge.top{top:10%;height:0}
    .gauge.bottom{bottom:10%;height:0}

    .target{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;color:#000;border-radius:999px;padding:10px 16px;font-weight:800;font-size:22px;border:1px solid #e5e7eb;cursor:pointer}
    .target.win{background:var(--accent);border-color:var(--accent);color:#000;box-shadow:none}

    .ecartA{position:absolute;left:14px;top:46%;font-size:12px;color:#fff;opacity:.95;font-style:italic}
    .roundCount{right:14px;top:46%;position:absolute;font-size:12px;color:#fff;opacity:.95;font-style:italic;text-align:right}

    .roundLabel_removed{position:absolute;left:50%;top:50%;transform:translate(-50%,-140%);font-size:12px;color:#fff;opacity:.95;font-style:italic;white-space:nowrap}

    .stackA{position:absolute;left:10%;top:18%;display:flex;flex-direction:column;gap:12px;align-items:center}
    .stackB{position:absolute;right:10%;bottom:18%;display:flex;flex-direction:column;gap:12px;align-items:center}
    .teamlabel{font-style:italic;font-weight:800;opacity:.95}
    .plusbtn{border:1px solid #2a2a2a;background:#0e0e0e;color:#fff;border-radius:999px;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-weight:900}
    .btn{border:1px solid #2a2a2a;background:#0e0e0e;color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer;font-weight:600}

    .scoreTag{position:absolute;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:6px 10px;border-radius:8px;border:1px solid #e5e7eb;font-weight:700;min-width:70px;text-align:center}
    #scoreA{top: calc(10% - 12px);}
    #scoreB{bottom: calc(10% - 12px);}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px}
    .modal.show{display:flex}
    .sheet{background:var(--card);border:1px solid #333;border-radius:16px;max-width:520px;width:100%}
    .sheet header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #262626}
    .sheet h3{margin:0;font-size:16px}
    .sheet .content{padding:12px 14px}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chipbd);color:#e2e8f0;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:13px}
    .chip:active{transform:scale(.96)}

    .keypad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .key{border:1px solid #2a2a2a;background:#121212;color:#fff;border-radius:12px;padding:12px 0;cursor:pointer;font-weight:600;text-align:center}
    .display{font-size:22px;text-align:center;border:1px solid #2a2a2a;border-radius:10px;padding:8px;background:#111}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .danger{color:var(--danger)}

    .history-list{max-height:60vh;overflow:auto}
    .rowh{display:grid;grid-template-columns:1fr 1fr 40px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #1f2937}
    .cell{background:#0b0b0b;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;text-align:center}
    .rnum{font-size:12px;color:#94a3b8;margin-right:8px}
    .bubble{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
    .bubble.points{background:#ffffff;color:#000;border:1px solid #e5e7eb}
    .bubble.annonce{background:#0a2010;color:#a7f3d0;border:1px solid #1a3b2b}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Compteur Chibre</h1>
      </div>
      <div class="actions">
        <button class="iconbtn" id="settingsBtn" title="Paramètres">
          <svg viewBox="0 0 24 24"><path d="M7.5 2 9 4.5l2-.5 1-2h2l1 2 2 .5L18.5 2 21 4.5 19.5 7l1 2 2 1v2l-2 1-1 2 1.5 2.5L18.5 22 16 20.5l-2 .5-1 2h-2l-1-2-2-.5L5.5 22 3 19.5 4.5 17l-1-2-2-1v-2l2-1 1-2L3 4.5 5.5 2 7.5 2Zm4.5 6a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/></svg>
        </button>
        <button class="iconbtn" id="historyBtn" title="Historique">
          <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 1 1-9 9H2l3-3 3 3H6a7 7 0 1 0 7-7V3Zm-1 5h2v6h-2V8Zm0 8h2v2h-2v-2Z"/></svg>
        </button>
        <button class="iconbtn danger" id="resetBtn" title="Tout réinitialiser">
          <svg viewBox="0 0 24 24"><path d="M3 6h18l-1.5 14.25A2 2 0 0 1 17.51 22H6.49a2 2 0 0 1-1.99-1.75L3 6Zm5-4h8l1 3H7l1-3Zm3 7h2v9h-2v-9Zm-4 0h2l-.5 9h-2l.5-9Zm10 0-1.5 9h-2L17 9h2Z"/></svg>
        </button>
      </div>
    </header>

    <div class="board" id="board">
      <div class="centerline"></div>
      <div id="gTop" class="gauge top"></div>
      <div id="gBot" class="gauge bottom"></div>
      <div class="midmark"></div>

      <div id="target" class="target">1000</div>

      <div id="ecartA" class="ecartA">Écart : 0</div>
      <div id="roundCount" class="roundCount">Manche : 0</div>
      <div class="stackA">
        <div class="teamlabel">TEAM 1</div>
        <button class="plusbtn" data-act="plusA">+</button>
        <button class="btn" data-act="annonceA">Annonce</button>
      </div>
      <div class="stackB">
        <button class="btn" data-act="annonceB">Annonce</button>
        <button class="plusbtn" data-act="plusB">+</button>
        <div class="teamlabel">TEAM 2</div>
      </div>

      <div id="scoreA" class="scoreTag">0</div>
      <div id="scoreB" class="scoreTag">0</div>
    </div>
  </div>

  <!-- Modale Annonce -->
  <div class="modal" id="annonce">
    <div class="sheet">
      <header><h3 id="aTitle">Annonce</h3></header>
      <div class="content">
        <div class="chips" id="aChips"></div>
        <div class="actions"><button id="aClose" class="btn">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modale Keypad -->
  <div class="modal" id="keypad">
    <div class="sheet">
      <header><h3 id="kTitle">Ajouter des points</h3></header>
      <div class="content">
        <div class="display" id="kDisp">0</div>
        <div class="keypad-grid">
          <button class="key">1</button><button class="key">2</button><button class="key">3</button>
          <button class="key">4</button><button class="key">5</button><button class="key">6</button>
          <button class="key">7</button><button class="key">8</button><button class="key">9</button>
          <button class="key">C</button><button class="key">0</button><button class="key">⌫</button>
        </div>
        <div class="actions">
          <button id="kCancel" class="btn">Annuler</button>
          <button id="kOk" class="btn">Valider</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale Historique -->
  <div class="modal" id="history">
    <div class="sheet">
      <header>
        <h3>Historique des manches</h3>
        <button id="hClose" class="iconbtn" title="Fermer"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" fill="none"/></svg></button>
      </header>
      <div class="content">
        <div class="history-list" id="hList"></div>
        <div class="actions"><button class="btn" id="hOk">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modale Paramètres -->
  <div class="modal" id="settings">
    <div class="sheet">
      <header><h3>Paramètres & Aide</h3></header>
      <div class="content">
        <div style="margin-bottom:8px"><strong>Installer l’app</strong></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <div style="font-weight:700;margin-bottom:4px">Android</div>
            <div class="muted" style="font-size:13px">
              Ouvrir dans Chrome → Menu ⋮ → <em>Installer l’app</em>.<br>
              Ou icône “Installer” si proposée.
            </div>
          </div>
          <div>
            <div style="font-weight:700;margin-bottom:4px">iPhone / iPad</div>
            <div class="muted" style="font-size:13px">
              Ouvrir dans Safari → bouton <em>Partager</em> → <em>Sur l’écran d’accueil</em>.
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px"><button class="btn" id="sClose">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modale Reset -->
  <div class="modal" id="confirm">
    <div class="sheet">
      <header><h3>Réinitialiser tout ?</h3></header>
      <div class="content">
        <div class="muted">Supprime équipes, scores, annonces et toutes les manches.</div>
        <div class="actions">
          <button id="cCancel" class="btn">Annuler</button>
          <button id="cOk" class="btn" style="color:var(--danger)">Tout supprimer</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const state = {
    target: 1000,
    roundTotal: 157,
    scoreA: 0,
    scoreB: 0,
    rounds: [] // {num, annA, annB, trA, trB}
  };

  // Load saved
  const saved = localStorage.getItem('cc_state_v8_1');
  if (saved) { try { Object.assign(state, JSON.parse(saved)); } catch(e){} }
  const save = ()=> localStorage.setItem('cc_state_v8_1', JSON.stringify(state));

  const gTop = byId('gTop'), gBot = byId('gBot');
  const scoreAEl = byId('scoreA'), scoreBEl = byId('scoreB');
  const targetEl = byId('target'), roundLabel = byId('roundLabel');
  const ecartA = byId('ecartA');

  function computeRoundLabel(){
    if (state.rounds.length===0) return 1;
    const last = state.rounds[state.rounds.length-1];
    const open = (last.trA===0 && last.trB===0); // annonces possibles, pas encore de plis
    return open ? last.num : last.num + 1;
  }

  function completedRounds(){
    return state.rounds.filter(r => (r && ((r.trA||0)>0 || (r.trB||0)>0))).length;
  }

  function refresh(){
    scoreAEl.textContent = state.scoreA;
    scoreBEl.textContent = state.scoreB;
    targetEl.textContent = state.target;
    roundLabel.textContent = 'Manche nº' + computeRoundLabel();

    const usable = 80, half = usable/2;
    const aPct = Math.min(1, state.scoreA / state.target);
    const bPct = Math.min(1, state.scoreB / state.target);
    gTop.style.height = (aPct*half) + '%';
    gBot.style.height = (bPct*half) + '%';

    const delta = state.scoreA - state.scoreB;
    ecartA.textContent = 'Écart : ' + delta;
    byId('roundCount').textContent = 'Manche : ' + completedRounds();

    // Win highlight
    const win = (state.scoreA >= state.target) || (state.scoreB >= state.target);
    targetEl.classList.toggle('win', win);
  }
  window.addEventListener('resize', refresh);
  refresh();

  // Change target
  targetEl.addEventListener('click', ()=> openKeypad('Changer objectif', state.target, v=>{
    let n = parseInt(v,10);
    if (isNaN(n) || n<=0) n = 1000;
    state.target = n; save(); refresh();
  }));

  // Buttons (plus / annonce)
  document.querySelectorAll('[data-act]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const act = b.getAttribute('data-act');
      if (act==='plusA') return openKeypad('Ajouter des points - Équipe A', 0, v=>addTricks('A', v));
      if (act==='plusB') return openKeypad('Ajouter des points - Équipe B', 0, v=>addTricks('B', v));
      if (act==='annonceA') return openAnnonce('A');
      if (act==='annonceB') return openAnnonce('B');
    });
  });

  function ensureRound(){
    const last = state.rounds[state.rounds.length-1];
    if (!last || (last.trA>0 || last.trB>0)){
      state.rounds.push({num: state.rounds.length+1, annA:0, annB:0, trA:0, trB:0});
    }
  }

  function addTricks(side, val){
    let n = parseInt(val,10)||0;
    if (n<0) n=0;
    if (n>state.roundTotal) n = state.roundTotal; // cap to 157
    const other = Math.max(0, state.roundTotal - n);
    ensureRound();
    const r = state.rounds[state.rounds.length-1];
    if (side==='A'){ r.trA = n; r.trB = other; state.scoreA += n; state.scoreB += other; }
    else { r.trA = other; r.trB = n; state.scoreA += other; state.scoreB += n; }
    save(); refresh();
  }

  function addAnnonce(side, val){
    ensureRound();
    const r = state.rounds[state.rounds.length-1];
    if (side==='A'){ r.annA += val; state.scoreA += val; }
    else { r.annB += val; state.scoreB += val; }
    save(); refresh();
  }

  // Annonce modal with options
  const annonce = byId('annonce'), aChips = byId('aChips'), aTitle = byId('aTitle');
  byId('aClose').addEventListener('click', ()=> annonce.classList.remove('show'));
  function openAnnonce(side){
    aTitle.textContent = side==='A' ? 'Annonce Équipe A' : 'Annonce Équipe B';
    aChips.innerHTML='';
    [20,50,100,150,200,250,300].forEach(v=>{
      const b=document.createElement('button'); b.className='chip'; b.textContent='+'+v;
      b.addEventListener('click', ()=>{ addAnnonce(side,v); annonce.classList.remove('show'); });
      aChips.appendChild(b);
    });
    annonce.classList.add('show');
  }
  annonce.addEventListener('click', (e)=>{ if(e.target===annonce) annonce.classList.remove('show'); });

  // History modal
  const history = byId('history'), hList = byId('hList');
  byId('historyBtn').addEventListener('click', ()=>{ renderHistory(); history.classList.add('show'); });
  byId('hOk').addEventListener('click', ()=> history.classList.remove('show'));
  byId('hClose').addEventListener('click', ()=> history.classList.remove('show'));
  function renderHistory(){
    hList.innerHTML='';
    state.rounds.forEach((r,idx)=>{
      if (!r) return;
      const empty = (r.annA|0)===0 && (r.annB|0)===0 && (r.trA|0)===0 && (r.trB|0)===0;
      if (empty) return;
      const row = document.createElement('div'); row.className='rowh';
      row.innerHTML = `
        <div class="cell">
          <span class="rnum">Manche ${r.num}</span><br>
          <span class="bubble points">${r.trA||0}</span>
          ${r.annA?`<span class="bubble annonce">+${r.annA} ann.</span>`:''}
        </div>
        <div class="cell">
          <span class="rnum">Manche ${r.num}</span><br>
          <span class="bubble points">${r.trB||0}</span>
          ${r.annB?`<span class="bubble annonce">+${r.annB} ann.</span>`:''}
        </div>
      `;
      const last = idx === state.rounds.length-1;
      const del = document.createElement('button'); del.className='iconbtn danger'; del.title='Supprimer la manche';
      del.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 6h18l-1.5 14.25A2 2 0 0 1 17.51 22H6.49a2 2 0 0 1-1.99-1.75L3 6Zm5-4h8l1 3H7l1-3Zm3 7h2v9h-2v-9Zm-4 0h2l-.5 9h-2l.5-9Zm10 0-1.5 9h-2L17 9h2Z"/></svg>';
      if (!last){ del.disabled=true; del.style.opacity=.35; del.title='Seule la dernière manche peut être supprimée'; }
      del.addEventListener('click', ()=>{
        if (!last) return;
        if (!confirm('Supprimer la dernière manche ? Annonces et points seront retirés.')) return;
        state.scoreA -= ((r.trA||0) + (r.annA||0));
        state.scoreB -= ((r.trB||0) + (r.annB||0));
        state.rounds.pop(); save(); refresh(); renderHistory();
      });
      row.appendChild(del);
      hList.appendChild(row);
    });
  }

  // Settings modal
  const settings = byId('settings');
  byId('sClose').addEventListener('click', ()=> settings.classList.remove('show'));
  byId('settingsBtn').addEventListener('click', ()=> settings.classList.add('show'));
  settings.addEventListener('click', (e)=>{ if(e.target===settings) settings.classList.remove('show'); });

  // Reset modal
  const confirmM = byId('confirm');
  byId('resetBtn').addEventListener('click', ()=> confirmM.classList.add('show'));
  byId('cCancel').addEventListener('click', ()=> confirmM.classList.remove('show'));
  byId('cOk').addEventListener('click', async ()=>{
    try{
      localStorage.removeItem('cc_state_v8_1');
      if ('serviceWorker' in navigator){ const regs = await navigator.serviceWorker.getRegistrations(); for (const r of regs) await r.unregister(); }
      if (window.caches){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
    }catch(e){}
    location.reload();
  });

  // Keypad
  const k = byId('keypad'); const kDisp = byId('kDisp'); const kTitle = byId('kTitle');
  let kResolve=null;
  function openKeypad(title, initial, onOk){
    kTitle.textContent = title; kDisp.textContent = String(Math.max(0, Math.min(157, initial||0)));
    k.classList.add('show'); kResolve = onOk;
  }
  byId('kCancel').addEventListener('click', ()=>{ k.classList.remove('show'); kResolve=null; });
  byId('kOk').addEventListener('click', ()=>{
    let v=parseInt(kDisp.textContent,10)||0;
    if (v<0) v=0; if (v>157) v=157;
    k.classList.remove('show'); if(kResolve)kResolve(v); kResolve=null;
  });
  k.addEventListener('click', (e)=>{ if(e.target===k){ k.classList.remove('show'); kResolve=null; }});
  k.querySelectorAll('.key').forEach(b=>{
    const t=b.textContent.trim();
    b.addEventListener('click',()=>{
      let cur=kDisp.textContent.trim();
      if(t==='C'){ kDisp.textContent='0'; return; }
      if(t==='⌫'){ kDisp.textContent = cur.length>1 ? cur.slice(0,-1) : '0'; return; }
      if(cur==='0') cur='';
      const next = (cur + t).slice(0,3);
      let num = parseInt(next||'0',10);
      if (isNaN(num)) num = 0;
      if (num>157) num = 157; if (num<0) num = 0;
      kDisp.textContent = String(num);
    });
  });

  // Service worker
  if ('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(console.error); }); }
})();
</script>
</body>
</html>
